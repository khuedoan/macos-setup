name: Test

on:
  workflow_dispatch: {}
  push:
    branches:
      - test

jobs:
  darwin-rebuild:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - run: make /nix
      - run: make /opt/homebrew/bin/brew
      - name: darwin-rebuild
        env:
          NIX_CONFIG: access-tokens = github.com=${{ github.token }}
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          sudo /nix/var/nix/profiles/default/bin/nix \
            --experimental-features 'nix-command flakes' \
            run \
            nix-darwin/nix-darwin-25.05#darwin-rebuild \
            -- \
            switch --flake .#MacBookPro
